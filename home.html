<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPM Compliance Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        /* New Custom Colors */
        .bg-soft-mint-white { background-color: #F4F9F9; }
        .text-dark-navy { color: #2E3A59; }
        .bg-teal-green-primary { background-color: #00BFA6; }
        .hover\:bg-teal-green-dark:hover { background-color: #009985; }
        .text-warm-yellow { color: #FFD166; }
        .bg-soft-red-critical { background-color: #FF6B6B; }
        .hover\:bg-soft-red-dark:hover { background-color: #CC5555; }
        
        /* General High-Contrast/Vibrant Styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F4F9F9; /* Soft mint white */
            padding-top: 100px; /* Adjusted for smaller, modern header */
            padding-bottom: 90px;
            line-height: 1.6;
        }
        .card {
            background-color: #ffffff;
            border: 1px solid #e0f2f1;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); /* Lighter shadow */
            transition: all 0.3s;
            border-radius: 1.5rem;
        }
        .card:hover {
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        /* Page Control & Transition */
        .page {
            display: none;
            padding: 1rem;
            min-height: calc(100vh - 190px);
        }
        .page.active {
            display: block;
            animation: slideInUp 0.6s ease-out forwards;
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(10%); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Fixed Header Styles */
        #fixed-header {
            z-index: 50;
            background-color: #00BFA6; /* Teal Green Primary */
            color: white;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Fixed Navbar Styles */
        #bottom-nav {
            background-color: #ffffff;
            border-top: 2px solid #e0f2f1;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.05);
            z-index: 60;
            height: 80px;
        }
        .nav-item {
            color: #2E3A59; /* Dark Navy */
            transition: color 0.3s, transform 0.2s;
            min-width: 20%;
        }
        .nav-item.active {
            color: #FFD166; /* Warm Yellow Accent */
            font-weight: bold;
            transform: scale(1.1);
        }

        /* Central Alert Button */
        #alert-center-btn-wrapper {
            position: relative;
            top: -25px; /* Moved up a bit */
            z-index: 70;
        }
        #alert-center-btn {
            background-color: #FF6B6B; /* Soft Red Critical */
            transition: all 0.1s;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.7);
            border: 6px solid #fca5a5;
        }
        .alert-active-pulse {
            animation: pulse-red 1.5s infinite; /* Adjusted speed */
        }
        @keyframes pulse-red {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 10px rgba(255, 107, 107, 0.7);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 25px rgba(255, 107, 107, 1);
            }
        }
        
        /* Custom Button & Animation Styles */
        .primary-btn {
            @apply text-dark-navy font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 active:scale-95 bg-warm-yellow hover:bg-yellow-400;
        }

        @keyframes pulse-soft {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
        
        /* Activity Icon Ripple (Motivation) */
        .ripple-icon {
            position: relative;
        }
        .ripple-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background-color: currentColor;
            border-radius: 50%;
            opacity: 0;
            transform: translate(-50%, -50%);
            animation: ripple 2s infinite ease-out;
        }
        @keyframes ripple {
            0% { width: 0; height: 0; opacity: 0.5; }
            100% { width: 150%; height: 150%; opacity: 0; }
        }
        .ripple-icon.delay::before { animation-delay: 1s; }


        /* Task done animation */
        .task-done {
            transition: all 0.5s ease-in-out;
            background-color: #f1fff1 !important; /* Lighter green */
            border-color: #00BFA6 !important;
            color: #00BFA6 !important;
        }
    </style>
    <script>
        // Configure Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'soft-mint-white': '#F4F9F9',
                        'teal-green-primary': '#00BFA6',
                        'warm-yellow': '#FFD166',
                        'soft-red-critical': '#FF6B6B',
                        'dark-navy': '#2E3A59',
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'ping-slow': 'ping 2s cubic-bezier(0, 0, 0.2, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'scale-up': 'scaleUp 0.5s ease-out forwards',
                        'float': 'float 3s ease-in-out infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                        'pulse-glow': 'pulseGlow 2s infinite',
                    },
                    keyframes: {
                        scaleUp: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' }, /* Reduced float for subtlety */
                        },
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        },
                        pulseGlow: {
                            '0%, 100%': { boxShadow: '0 0 5px rgba(0, 191, 166, 0.5)' },
                            '50%': { boxShadow: '0 0 20px rgba(0, 191, 166, 0.8)' },
                        }
                    }
                }
            }
        }
        
        // Initialize Lucide icons
        window.createLucideIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons({ 
                    attrs: { 
                        'stroke-width': 2, 
                        'class': 'lucide' 
                    } 
                });
            }
        };
        document.addEventListener('DOMContentLoaded', window.createLucideIcons);
    </script>
</head>
<body>

    <header id="fixed-header" class="fixed top-0 left-0 right-0 h-24 flex items-center">
        <div class="max-w-4xl mx-auto flex items-center justify-between w-full px-4">
            <div class="flex items-center space-x-4">
                <i data-lucide="compass" class="w-8 h-8 text-warm-yellow animate-spin-slow"></i>
                <div>
                    <p class="text-xl font-bold">Hello, <span id="header-user-name">John Doe</span></p>
                    <p class="text-sm text-white flex items-center opacity-80">
                        <i data-lucide="sun" class="w-4 h-4 mr-1"></i> Good Morning!
                    </p>
                </div>
            </div>
            <button onclick="changePage('settings', document.querySelector('#bottom-nav button:last-child'))" class="p-2 rounded-full hover:bg-teal-green-dark transition">
                 <i data-lucide="user" class="w-6 h-6 text-warm-yellow"></i>
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto pt-4">

        <div id="page-home" class="page active">
            
            <div class="flex justify-around items-center mb-6 card p-4 bg-white shadow-xl">
                <button onclick="handleAlertHoldStart(event); setTimeout(() => handleAlertHoldEnd(event), 3000);" class="flex flex-col items-center nav-item transform hover:scale-110 active:scale-95 transition-all">
                    <i data-lucide="siren" class="w-8 h-8 text-soft-red-critical animate-pulse-soft"></i>
                    <span class="text-xs font-semibold text-soft-red-critical mt-1">SOS</span>
                </button>
                <button onclick="triggerSmartAlert('doctor', 'Secure daily report: Compliance score ${calculateHealthScore()}%.');" class="flex flex-col items-center nav-item transform hover:scale-110 active:scale-95 transition-all">
                    <i data-lucide="phone-call" class="w-8 h-8 text-dark-navy hover:text-teal-green-primary"></i>
                    <span class="text-xs font-semibold text-dark-navy mt-1">Call Doctor</span>
                </button>
                <button onclick="changePage('settings', document.querySelector('#bottom-nav button:last-child'))" class="flex flex-col items-center nav-item transform hover:scale-110 active:scale-95 transition-all">
                    <i data-lucide="file-text" class="w-8 h-8 text-dark-navy hover:text-teal-green-primary"></i>
                    <span class="text-xs font-semibold text-dark-navy mt-1">Reports</span>
                </button>
                <button onclick="changePage('todo', document.querySelector('#bottom-nav button:nth-child(2)'))" class="flex flex-col items-center nav-item transform hover:scale-110 active:scale-95 transition-all">
                    <i data-lucide="list-checks" class="w-8 h-8 text-dark-navy hover:text-teal-green-primary"></i>
                    <span class="text-xs font-semibold text-dark-navy mt-1">To-Do List</span>
                </button>
            </div>
            
            <div class="card p-6 mb-6 bg-gradient-to-r from-soft-mint-white to-white border-l-8 border-warm-yellow" id="medication-tracker-card">
                <h3 class="text-xl font-bold text-dark-navy mb-3 flex items-center">
                    <i data-lucide="pill" class="w-6 h-6 mr-2 text-warm-yellow"></i> Medication Tracker
                </h3>
                <div class="flex items-center justify-between">
                    <div class="relative w-20 h-20">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50"/>
                            <circle id="med-progress-ring" class="text-teal-green-primary transition-all duration-1000 ease-out" stroke-width="10" stroke-dasharray="251.2" stroke-dashoffset="75.36" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" transform="rotate(-90 50 50)"/>
                            <text id="med-progress-text" x="50" y="55" font-size="20" text-anchor="middle" class="font-bold text-dark-navy">70%</text>
                        </svg>
                    </div>
                    <div class="text-right">
                        <p class="text-3xl font-extrabold text-teal-green-primary" id="doses-taken-display">2/3</p>
                        <p class="text-sm text-gray-600">Doses Taken Today</p>
                    </div>
                </div>
                <div class="mt-4 p-3 rounded-lg border border-warm-yellow bg-yellow-50 animate-pulse-soft">
                    <p class="font-semibold text-sm text-gray-800 flex items-center">
                        <i data-lucide="clock" class="w-4 h-4 mr-2 text-warm-yellow"></i> Next Dose: <span id="next-med-display-home" class="ml-1 font-bold">Aspirin at 8:00 PM</span>
                    </p>
                </div>
            </div>

            <div id="health-summary-card" class="card p-6 mb-6 bg-gradient-to-tr from-white to-soft-mint-white">
                <h3 class="text-xl font-bold text-dark-navy mb-3 flex items-center">
                    <i data-lucide="heart-pulse" class="w-6 h-6 mr-2 text-soft-red-critical animate-pulse-soft"></i> Live Vitals Overview
                </h3>
                <div class="grid grid-cols-2 gap-4 text-dark-navy text-lg font-semibold">
                    <div id="vitals-hr" class="p-3 rounded-lg flex items-center space-x-2 border-l-4 border-green-500 bg-green-50">
                        <i data-lucide="heart" class="w-5 h-5 text-green-700"></i>
                        <span>HR: <span id="hr-display-home">72</span> bpm</span>
                    </div>
                    <div id="vitals-bp" class="p-3 rounded-lg flex items-center space-x-2 border-l-4 border-yellow-500 bg-yellow-50">
                        <i data-lucide="thermometer-half" class="w-5 h-5 text-yellow-700"></i>
                        <span>BP: <span id="bp-display-home">120/80</span> mmHg</span>
                    </div>
                    <div id="vitals-bg" class="p-3 rounded-lg flex items-center space-x-2 border-l-4 border-green-500 bg-green-50">
                        <i data-lucide="droplet" class="w-5 h-5 text-green-700"></i>
                        <span>Glucose: <span id="bg-display-home">110</span> mg/dL</span>
                    </div>
                    <div id="vitals-spo2" class="p-3 rounded-lg flex items-center space-x-2 border-l-4 border-green-500 bg-green-50">
                        <i data-lucide="wind" class="w-5 h-5 text-green-700"></i>
                        <span>SpO2: <span id="spo2-display-home">97</span>%</span>
                    </div>
                </div>
            </div>
            
            <div class="card p-6 mb-6">
                 <h3 class="text-xl font-bold text-dark-navy mb-4 flex items-center">
                    <i data-lucide="footprints" class="w-6 h-6 mr-2 text-teal-green-primary"></i> Daily Activity
                </h3>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="flex flex-col items-center">
                        <div class="p-3 rounded-full bg-teal-green-primary text-white mb-2 ripple-icon">
                            <i data-lucide="shoe" class="w-6 h-6"></i>
                        </div>
                        <p class="text-lg font-bold text-dark-navy">4,356</p>
                        <p class="text-xs text-gray-500">Steps</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="p-3 rounded-full bg-blue-500 text-white mb-2 ripple-icon delay">
                            <i data-lucide="droplets" class="w-6 h-6"></i>
                        </div>
                        <p class="text-lg font-bold text-dark-navy">6/8</p>
                        <p class="text-xs text-gray-500">Water (glasses)</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="p-3 rounded-full bg-purple-500 text-white mb-2 ripple-icon">
                            <i data-lucide="moon" class="w-6 h-6"></i>
                        </div>
                        <p class="text-lg font-bold text-dark-navy">7.2 hrs</p>
                        <p class="text-xs text-gray-500">Sleep</p>
                    </div>
                </div>
            </div>
            
            <div id="alerts-container" class="space-y-3">
                 <div class="card p-4 bg-soft-red-critical text-white flex items-center space-x-3 animate-wiggle">
                    <i data-lucide="bell" class="w-6 h-6 flex-shrink-0"></i>
                    <p class="font-semibold">ALERT: BP reading slightly high. Please recheck in 30 mins.</p>
                </div>
                <div class="card p-4 bg-warm-yellow text-dark-navy flex items-center space-x-3">
                    <i data-lucide="calendar-check" class="w-6 h-6 flex-shrink-0"></i>
                    <p class="font-semibold">Gentle Reminder: Doctor visit tomorrow at 10 AM.</p>
                </div>
            </div>

            <div class="card p-6 bg-soft-mint-white mt-6 hidden">
                <form id="vitals-form" class="space-y-4">
                    <input type="number" id="input-hr" placeholder="Heart Rate (bpm)">
                    <input type="text" id="input-bp" placeholder="BP (e.g., 120/80)">
                    <input type="number" id="input-bg" placeholder="Blood Glucose (mg/dL)">
                    <input type="number" id="input-spo2" placeholder="SpO2 (%)">
                    <button type="submit">Save Vitals</button>
                </form>
            </div>
        </div>

        <div id="page-todo" class="page">
            
            <h2 class="text-3xl font-bold text-dark-navy mb-5 flex items-center">
                <i data-lucide="heart" class="w-8 h-8 mr-2 text-soft-red-critical inline-block animate-pulse-soft"></i> My Health Tasks Today
            </h2>
            
            <div class="card p-4 mb-6 bg-soft-mint-white">
                 <h3 class="text-xl font-bold text-dark-navy mb-3">âž• Add New Task</h3>
                 <form id="add-task-form" class="space-y-3">
                     <input type="text" id="new-task-title" placeholder="Task Title (e.g., Take BP Pill)" class="w-full p-3 border-2 border-teal-green-primary rounded-lg text-lg focus:ring-teal-green-primary focus:border-teal-green-primary">
                     <div class="grid grid-cols-2 gap-3">
                         <input type="time" id="new-task-time" class="w-full p-3 border-2 border-teal-green-primary rounded-lg text-lg focus:ring-teal-green-primary focus:border-teal-green-primary">
                         <select id="new-task-type" class="w-full p-3 border-2 border-teal-green-primary rounded-lg text-lg focus:ring-teal-green-primary focus:border-teal-green-primary bg-white">
                             <option value="Pill">Medication</option>
                             <option value="Footprints">Exercise</option>
                             <option value="Droplets">Hydration</option>
                             <option value="Activity">Vitals Check</option>
                             <option value="NotebookPen">Other</option>
                         </select>
                     </div>
                     <button type="submit" class="w-full bg-teal-green-primary hover:bg-teal-green-dark text-white font-bold py-3 rounded-xl transition-all duration-300 transform hover:scale-105 active:scale-95 animate-pulse-glow">
                         <i data-lucide="plus" class="w-5 h-5 inline-block mr-2"></i> Add Task
                     </button>
                 </form>
            </div>

            <div id="task-list" class="space-y-4">
                </div>
            
             <div class="card p-4 mt-6 bg-yellow-50 border-t-4 border-warm-yellow">
                <h3 class="text-xl font-bold text-dark-navy mb-3">ðŸ“… Tomorrow's Preview</h3>
                <div id="tomorrow-preview" class="flex overflow-x-auto space-x-4">
                     <div class="p-3 bg-white border border-gray-200 rounded-lg flex-shrink-0 w-40 text-center">
                        <i data-lucide="clock" class="w-5 h-5 text-gray-500 mx-auto"></i>
                        <p class="text-sm font-semibold mt-1">8:00 AM</p>
                        <p class="text-xs text-gray-600">Morning BP Check</p>
                    </div>
                     <div class="p-3 bg-white border border-gray-200 rounded-lg flex-shrink-0 w-40 text-center">
                        <i data-lucide="user-check" class="w-5 h-5 text-blue-500 mx-auto"></i>
                        <p class="text-sm font-semibold mt-1">10:00 AM</p>
                        <p class="text-xs text-gray-600">Doctor Visit Reminder</p>
                    </div>
                     <div class="p-3 bg-white border border-gray-200 rounded-lg flex-shrink-0 w-40 text-center">
                        <i data-lucide="pill" class="w-5 h-5 text-green-500 mx-auto"></i>
                        <p class="text-sm font-semibold mt-1">1:00 PM</p>
                        <p class="text-xs text-gray-600">Vitamin Dose Schedule</p>
                    </div>
                </div>
            </div>
            
        </div>
        
        <div id="page-progress" class="page text-center">
             <h2 class="text-3xl font-bold text-dark-navy mb-5">
                <i data-lucide="trophy" class="w-8 h-8 mr-2 text-warm-yellow inline-block"></i> Your Progress
            </h2>
            
            <div class="card p-6 mb-6 bg-orange-50">
                <div class="flex items-center justify-center space-x-4">
                    <i data-lucide="flame" class="w-10 h-10 text-orange-500"></i>
                    <div>
                        <p class="text-xl text-gray-600 font-semibold">Current Streak</p>
                        <p class="text-4xl font-extrabold text-orange-700"><span id="streak-display">3</span> days</p>
                    </div>
                </div>
            </div>
            
            <div class="card p-6 mb-8 bg-yellow-50">
                <p class="text-xl text-gray-600 font-semibold">Your Current Health Level:</p>
                <div class="text-6xl font-extrabold text-teal-700 my-3 relative inline-block">
                    Level <span id="level-display">5</span>
                    <i data-lucide="zap" class="w-8 h-8 absolute top-0 right-[-30px] text-orange-500 animate-bounce-slow"></i>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden">
                    <div id="progress-bar" class="bg-orange-500 h-4 rounded-full transition-all duration-1000 ease-out" style="width: 65%;"></div>
                    <span class="absolute top-0 left-1/2 transform -translate-x-1/2 text-sm text-white font-bold">65% to next level!</span>
                </div>
            </div>
            
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-dark-navy mb-4 flex items-center">
                    <i data-lucide="award" class="w-6 h-6 mr-2 text-warm-yellow"></i> Badges Earned
                </h3>
                <div id="badges-container" class="grid grid-cols-3 sm:grid-cols-5 gap-4">
                    </div>
            </div>
            
            <div id="levelup-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden" onclick="this.classList.add('hidden')">
                <div class="bg-white p-8 rounded-3xl text-center shadow-2xl relative animate-scale-up" onclick="event.stopPropagation()">
                    <i data-lucide="star" class="w-16 h-16 text-yellow-500 mx-auto animate-spin-slow"></i>
                    <h3 class="text-4xl font-extrabold text-green-600 mt-4">LEVEL UP!</h3>
                    <p class="text-2xl text-gray-700 mt-2">You reached Level <span id="new-level-display">6</span>!</p>
                    <button class="mt-5 px-6 py-3 bg-teal-500 text-white font-bold rounded-xl hover:bg-teal-600 transition-all">Awesome!</button>
                </div>
            </div>
        </div>

        <div id="page-settings" class="page">
            <h2 class="text-3xl font-bold text-dark-navy mb-5">
                <i data-lucide="settings" class="w-8 h-8 mr-2 text-warm-yellow inline-block"></i> Settings & Reports
            </h2>
             <div class="space-y-6">
                <div class="card p-6">
                    <h3 class="text-2xl font-bold text-dark-navy mb-3 flex items-center">
                        <i data-lucide="user" class="w-6 h-6 mr-2 text-blue-500"></i> Profile Settings
                    </h3>
                    <form id="profile-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Full Name</label>
                                <input type="text" id="profile-name" class="w-full p-3 border-2 border-teal-300 rounded-lg text-lg focus:ring-teal-green-primary focus:border-teal-green-primary">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Date of Birth</label>
                                <input type="date" id="profile-dob" class="w-full p-3 border-2 border-teal-300 rounded-lg text-lg focus:ring-teal-green-primary focus:border-teal-green-primary">
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Health Conditions</label>
                            <textarea id="profile-conditions" rows="3" class="w-full p-3 border-2 border-teal-300 rounded-lg text-lg focus:ring-teal-green-primary focus:border-teal-green-primary" placeholder="List any health conditions..."></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Emergency Contact</label>
                            <input type="text" id="profile-emergency-contact" class="w-full p-3 border-2 border-teal-300 rounded-lg text-lg focus:ring-teal-green-primary focus:border-teal-green-primary" placeholder="Name and phone number">
                        </div>
                        <button type="submit" class="w-full bg-teal-green-primary hover:bg-teal-green-dark text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 active:scale-95">Save Profile</button>
                    </form>
                </div>

                <div class="card p-6 bg-soft-mint-white">
                    <h3 class="text-2xl font-bold text-dark-navy mb-3 flex items-center">
                        <i data-lucide="users" class="w-6 h-6 mr-2 text-green-500"></i> Connection Settings
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-teal-200">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="user-check" class="w-6 h-6 text-green-500"></i>
                                <div>
                                    <p class="font-semibold">Dr. Sarah Johnson</p>
                                    <p class="text-sm text-gray-500">Primary Care Physician</p>
                                }
                            </div>
                            <button class="px-4 py-2 bg-teal-green-primary text-white rounded-lg hover:bg-teal-green-dark transition-colors">Manage</button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-teal-200">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="users-2" class="w-6 h-6 text-orange-500"></i>
                                <div>
                                    <p class="font-semibold">Family Members</p>
                                    <p class="text-sm text-gray-500">3 connected family members</p>
                                </div>
                            </div>
                            <button class="px-4 py-2 bg-teal-green-primary text-white rounded-lg hover:bg-teal-green-dark transition-colors">Manage</button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-teal-200">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="activity" class="w-6 h-6 text-purple-500"></i>
                                <div>
                                    <p class="font-semibold">Health Devices</p>
                                    <p class="text-sm text-gray-500">2 connected devices</p>
                                </div>
                            </div>
                            <button class="px-4 py-2 bg-teal-green-primary text-white rounded-lg hover:bg-teal-green-dark transition-colors">Manage</button>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6 bg-blue-50">
                    <h3 class="text-2xl font-bold text-dark-navy mb-3 flex items-center">
                        <i data-lucide="database" class="w-6 h-6 mr-2 text-blue-500"></i> ABDM Data Export
                    </h3>
                    <p class="text-lg text-gray-600 mb-4">Export your health data in ABDM-compatible format for sharing with healthcare providers.</p>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-blue-200">
                            <div>
                                <p class="font-semibold">Health Data Summary</p>
                                <p class="text-sm text-gray-500">Vitals, medications, and compliance data</p>
                            </div>
                            <button id="export-abdm-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                <span>Export CSV</span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-blue-200">
                            <div>
                                <p class="font-semibold">Medication History</p>
                                <p class="text-sm text-gray-500">Complete medication adherence records</p>
                            </div>
                            <button id="export-meds-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                <span>Export CSV</span>
                            </button>
                        </div>
                    </div>
                    <div id="export-status" class="mt-4 text-center font-semibold text-lg"></div>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-3 text-dark-navy flex items-center">
                        <i data-lucide="activity" class="w-6 h-6 mr-2 text-blue-500"></i> Risk Forecasting
                    </h3>
                    <p class="text-lg text-gray-600 mb-4">Risk trend based on recent data:</p>
                    
                    <div id="chart-container" class="flex justify-around items-end h-48 border-b-2 border-gray-200 pt-2">
                        </div>
                    <div id="chart-labels" class="flex justify-around text-sm font-medium text-gray-500 mt-2">
                        </div>
                    <p id="predictive-insight" class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-400 text-blue-800 text-lg font-medium">
                        <span class="font-bold">Insight:</span> Keep your adherence above 80% to maintain a low-risk status.
                    </p>
                </div>

                <div class="card p-6 bg-soft-mint-white">
                    <h3 class="text-2xl font-bold text-dark-navy mb-3 flex items-center">
                        <i data-lucide="send" class="w-6 h-6 mr-2 text-green-500"></i> Share Progress
                    </h3>
                    <p class="text-xl text-gray-600 mb-4">Securely share your health summary.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="alert-family-btn" class="w-full primary-btn bg-warm-yellow hover:bg-yellow-400 shadow-md flex items-center justify-center space-x-2">
                            <i data-lucide="users" class="w-6 h-6"></i>
                            <span>Send to Family</span>
                        </button>
                        <button id="alert-doctor-btn" class="w-full primary-btn bg-teal-green-primary hover:bg-teal-green-dark text-white shadow-md flex items-center justify-center space-x-2">
                            <i data-lucide="user-check" class="w-6 h-6"></i>
                            <span>Send to Doctor</span>
                        </button>
                    </div>
                    <p id="alert-status" class="mt-4 text-center font-semibold text-xl"></p>
                </div>
            </div>
        </div>
    </main>

    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 h-20 flex justify-around items-center">
        <button onclick="changePage('home', this)" class="nav-item flex flex-col items-center justify-center active">
            <i data-lucide="home" class="w-7 h-7"></i>
            <span class="text-xs">Home</span>
        </button>
        <button onclick="changePage('todo', this)" class="nav-item flex flex-col items-center justify-center">
            <i data-lucide="list-checks" class="w-7 h-7"></i>
            <span class="text-xs">To Do</span>
        </button>

        <div id="alert-center-btn-wrapper" class="flex-shrink-0">
            <button id="alert-center-btn"
                    class="w-20 h-20 rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-2xl transform transition duration-150"
                    ontouchstart="handleAlertHoldStart(event)"
                    ontouchend="handleAlertHoldEnd(event)"
                    onmousedown="handleAlertHoldStart(event)"
                    onmouseup="handleAlertHoldEnd(event)"
                    ontouchmove="handleAlertHoldMove(event)">
                <i data-lucide="siren" class="w-8 h-8"></i>
            </button>
        </div>

        <button onclick="changePage('progress', this)" class="nav-item flex flex-col items-center justify-center">
            <i data-lucide="trending-up" class="w-7 h-7"></i>
            <span class="text-xs">Progress</span>
        </button>
        <button onclick="changePage('settings', this)" class="nav-item flex flex-col items-center justify-center">
            <i data-lucide="settings" class="w-7 h-7"></i>
            <span class="text-xs">Settings</span>
        </button>
    </nav>

    <script>
        // --- DATA & CONFIGURATION ---
        const TODAY_DATE_KEY = new Date().toDateString();

        const INITIAL_STATE = {
            profile: {
                name: "John Doe",
                dob: "1975-05-15",
                conditions: "Hypertension, Type 2 Diabetes",
                emergencyContact: "Jane Doe - (555) 123-4567"
            },
            tasks: [
                { id: 1, name: 'Take Blood Pressure', icon: 'Activity', isChecked: false, target: 120, unit: 'mmHg', time: '8:00 AM' },
                { id: 2, name: 'Check Blood Glucose', icon: 'Activity', isChecked: false, target: 100, unit: 'mg/dL', time: '8:30 AM' },
                { id: 3, name: 'Take Morning Medication', icon: 'Pill', isChecked: false, target: 1, unit: 'pill', time: '9:00 AM' },
                { id: 4, name: '30 min Walk/Exercise', icon: 'Footprints', isChecked: false, target: 30, unit: 'min', time: '5:00 PM' },
                { id: 5, name: 'Take Evening Medication', icon: 'Pill', isChecked: false, target: 1, unit: 'pill', time: '8:00 PM' },
            ],
            vitals: {
                hr: 72,
                bp: '130/80', // Slightly high for alert demo
                bg: 105,
                spo2: 97
            },
            medicationHistory: [
                { date: 'Mon', meds: ['Aspirin (AM)', 'Metformin (AM)'], nextDose: 'Aspirin at 8:00 PM', dosesTaken: 2, totalDoses: 3 },
                { date: 'Sun', meds: ['Aspirin (AM)', 'Metformin (AM)', 'Aspirin (PM)'], nextDose: 'Aspirin (AM)', dosesTaken: 3, totalDoses: 3 },
            ],
            gamification: {
                streak: 3,
                level: 5,
                progressToNextLevel: 65,
                badges: [
                    { id: 1, name: 'First Check-in', icon: 'CheckCircle', earned: true, color: 'bg-yellow-400' },
                    { id: 2, name: 'Consistent Care', icon: 'CalendarCheck', earned: false, color: 'bg-gray-300' },
                    { id: 3, name: 'Low Risk Status', icon: 'Shield', earned: false, color: 'bg-gray-300' },
                    { id: 4, name: 'Active Achiever', icon: 'Footprints', earned: true, color: 'bg-green-400' },
                    { id: 5, name: 'Perfect Week', icon: 'Star', earned: false, color: 'bg-gray-300' },
                    { id: 6, name: 'Vitals Master', icon: 'Activity', earned: false, color: 'bg-gray-300' },
                    { id: 7, name: 'Medication Pro', icon: 'Pill', earned: false, color: 'bg-gray-300' },
                    { id: 8, name: 'Health Champion', icon: 'Award', earned: false, color: 'bg-gray-300' },
                    { id: 9, name: 'Early Bird', icon: 'Sunrise', earned: false, color: 'bg-gray-300' },
                    { id: 10, name: 'Night Owl', icon: 'Moon', earned: false, color: 'bg-gray-300' },
                ],
            },
            healthData: [
                { day: 'Mon', score: 75, risk: 25 },
                { day: 'Tue', score: 80, risk: 20 },
                { day: 'Wed', score: 85, risk: 15 },
                { day: 'Thu', score: 90, risk: 10 },
                { day: 'Fri', score: 82, risk: 18 },
                { day: 'Sat', score: 95, risk: 5 },
                { day: 'Sun', score: 98, risk: 2 },
            ],
            currentPage: 'home',
            lastUpdatedDate: null,
            taskIdCounter: 6 // To ensure new tasks get unique IDs
        };

        let appState = {};
        let alertTimeout = null;
        const ALERT_HOLD_DURATION = 3000;
        const alertBtn = document.getElementById('alert-center-btn');

        // --- LOCAL STORAGE FUNCTIONS (Unchanged) ---
        const loadState = () => {
            const savedState = localStorage.getItem('rpmCoachState');
            if (savedState) {
                appState = JSON.parse(savedState);
                
                // Reset tasks if it's a new day
                if (appState.lastUpdatedDate !== TODAY_DATE_KEY) {
                    appState.tasks = INITIAL_STATE.tasks.map(t => ({ ...t, isChecked: false }));
                    appState.lastUpdatedDate = TODAY_DATE_KEY;
                }
            } else {
                appState = { 
                    ...INITIAL_STATE, 
                    tasks: INITIAL_STATE.tasks.map(t => ({ ...t })),
                    lastUpdatedDate: TODAY_DATE_KEY
                };
            }
        };

        const saveState = () => {
            localStorage.setItem('rpmCoachState', JSON.stringify(appState));
        };

        // --- CELEBRATION FUNCTIONS (Unchanged) ---
        const triggerCelebration = (type = 'achievement') => {
            // Confetti celebration
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            // Additional effects based on type
            if (type === 'levelup') {
                setTimeout(() => {
                    confetti({
                        particleCount: 100,
                        angle: 60,
                        spread: 80,
                        origin: { x: 0 }
                    });
                    confetti({
                        particleCount: 100,
                        angle: 120,
                        spread: 80,
                        origin: { x: 1 }
                    });
                }, 250);
            }
            
            // Show achievement popup
            const popup = document.getElementById('achievement-popup');
            const achievementText = document.getElementById('achievement-text');
            
            if (type === 'levelup') {
                achievementText.textContent = `You've reached Level ${appState.gamification.level}!`;
            } else {
                achievementText.textContent = "You've earned a new badge!";
            }
            
            // Ensure HTML for popup exists before showing
            if(popup) {
                popup.classList.remove('hidden');
                setTimeout(() => {
                    popup.classList.add('hidden');
                }, 3000);
            }
        };

        // --- BADGE CHECKING & UTILITY FUNCTIONS (Unchanged for core logic) ---
        const checkForNewBadges = (oldScore, newScore) => {
            // Existing logic...
            const newlyEarnedBadges = [];
            
            // Check for Perfect Week badge (7-day streak)
            if (appState.gamification.streak >= 7) {
                const badge = appState.gamification.badges.find(b => b.id === 5);
                if (badge && !badge.earned) {
                    badge.earned = true;
                    badge.color = 'bg-purple-400';
                    newlyEarnedBadges.push(badge);
                }
            }
            
            // Check for Vitals Master badge (consistent vitals logging)
            const vitalsLogged = appState.healthData.filter(d => d.score > 80).length;
            if (vitalsLogged >= 5) {
                const badge = appState.gamification.badges.find(b => b.id === 6);
                if (badge && !badge.earned) {
                    badge.earned = true;
                    badge.color = 'bg-blue-400';
                    newlyEarnedBadges.push(badge);
                }
            }
            
            // Check for Medication Pro badge (perfect medication adherence)
            if (newScore === 100) {
                const badge = appState.gamification.badges.find(b => b.id === 7);
                if (badge && !badge.earned) {
                    badge.earned = true;
                    badge.color = 'bg-green-400';
                    newlyEarnedBadges.push(badge);
                }
            }
            
            // Check for Health Champion badge (level 10)
            if (appState.gamification.level >= 10) {
                const badge = appState.gamification.badges.find(b => b.id === 8);
                if (badge && !badge.earned) {
                    badge.earned = true;
                    badge.color = 'bg-red-400';
                    newlyEarnedBadges.push(badge);
                }
            }
            
            // Return any newly earned badges
            return newlyEarnedBadges;
        };

        const calculateHealthScore = () => {
            const completed = appState.tasks.filter(t => t.isChecked).length;
            const total = appState.tasks.length;
            return total > 0 ? Math.round((completed / total) * 100) : 0;
        };

        const checkLevelUp = (oldScore, newScore) => {
            const oldLevel = appState.gamification.level;
            
            if (newScore > 90 && oldScore <= 90) {
                appState.gamification.level += 1;
                appState.gamification.progressToNextLevel = 10;
                showLevelUpAnimation(appState.gamification.level);
                
                // Earn a badge if available
                const lowRiskBadge = appState.gamification.badges.find(b => b.id === 3);
                if (lowRiskBadge && !lowRiskBadge.earned) {
                    lowRiskBadge.earned = true;
                    lowRiskBadge.color = 'bg-yellow-400';
                }
            } else if (newScore > oldScore) {
                appState.gamification.progressToNextLevel = Math.min(100, appState.gamification.progressToNextLevel + (newScore - oldScore) / 2);
            }
            
            // Check if level increased to trigger celebration
            if (appState.gamification.level > oldLevel) {
                triggerCelebration('levelup');
            }
        };
        
        const showLevelUpAnimation = (newLevel) => {
            const modal = document.getElementById('levelup-modal');
            document.getElementById('new-level-display').textContent = newLevel;
            modal.classList.remove('hidden');
            // Removed the setTimeout to re-hide the modal as the click handler takes care of it
        };
        
        const getVitalsStatus = (vitalsKey) => {
            const vitals = appState.vitals;
            let status = 'normal';

            switch (vitalsKey) {
                case 'hr':
                    if (vitals.hr > 90 || vitals.hr < 60) status = 'warning';
                    break;
                case 'bp':
                    const [systolic, diastolic] = vitals.bp.split('/').map(Number);
                    if (systolic > 130 || diastolic > 85) status = 'warning';
                    if (systolic >= 140 || diastolic >= 90) status = 'critical';
                    break;
                case 'bg':
                    if (vitals.bg > 120 || vitals.bg < 70) status = 'warning';
                    break;
                case 'spo2':
                    if (vitals.spo2 < 95) status = 'critical';
                    if (vitals.spo2 < 97) status = 'warning';
                    break;
            }
            return status;
        };

        const getStatusStyles = (status) => {
            switch (status) {
                case 'critical': return { border: 'border-soft-red-critical', bg: 'bg-red-100', text: 'text-red-700', icon: 'text-red-700' };
                case 'warning': return { border: 'border-warm-yellow', bg: 'bg-yellow-100', text: 'text-yellow-700', icon: 'text-yellow-700' };
                case 'normal':
                default: return { border: 'border-teal-green-primary', bg: 'bg-green-100', text: 'text-green-700', icon: 'text-green-700' };
            }
        };

        // --- UI RENDER FUNCTIONS ---
        const renderHeader = () => {
            document.getElementById('header-user-name').textContent = appState.profile.name;
            
            // RENDER HOME PAGE VITALS
            const vitalsMap = {
                'hr': { el: 'hr-display-home', icon: 'heart' },
                'bp': { el: 'bp-display-home', icon: 'thermometer-half' },
                'bg': { el: 'bg-display-home', icon: 'droplet' },
                'spo2': { el: 'spo2-display-home', icon: 'wind' }
            };

            for (const key in vitalsMap) {
                const el = document.getElementById(vitalsMap[key].el);
                if (el) el.textContent = appState.vitals[key];
                
                // Apply conditional styling to the container
                const containerEl = document.getElementById(`vitals-${key}`);
                if (containerEl) {
                    const status = getVitalsStatus(key);
                    const styles = getStatusStyles(status);

                    // Clear existing classes and apply new ones
                    containerEl.className = `p-3 rounded-lg flex items-center space-x-2 border-l-4 ${styles.border} ${styles.bg}`;
                    
                    // Update icon color
                    const iconEl = containerEl.querySelector(`i[data-lucide="${vitalsMap[key].icon}"]`);
                    if(iconEl) {
                        iconEl.className = `w-5 h-5 ${styles.icon}`;
                    }
                }
            }

            // Medication Tracker (Home Page)
            const todayMeds = appState.medicationHistory[0];
            if (todayMeds) {
                const dosesTaken = appState.tasks.filter(t => t.icon === 'Pill' && t.isChecked).length;
                const totalDoses = appState.tasks.filter(t => t.icon === 'Pill').length;

                const nextDoseText = todayMeds.nextDose || 'None Scheduled';
                const nextDoseEl = document.getElementById('next-med-display-home');
                if(nextDoseEl) nextDoseEl.textContent = nextDoseText;
                
                const dosesDisplay = document.getElementById('doses-taken-display');
                if(dosesDisplay) dosesDisplay.textContent = `${dosesTaken}/${totalDoses}`;

                const progressRing = document.getElementById('med-progress-ring');
                const progressText = document.getElementById('med-progress-text');

                if (progressRing && progressText) {
                    const percentage = totalDoses > 0 ? Math.round((dosesTaken / totalDoses) * 100) : 0;
                    const circumference = 2 * Math.PI * 40; // R=40
                    const offset = circumference - (percentage / 100) * circumference;

                    progressRing.style.strokeDashoffset = offset;
                    progressText.textContent = `${percentage}%`;
                    
                    // Change color based on completion
                    progressRing.classList.remove('text-teal-green-primary', 'text-yellow-500', 'text-soft-red-critical');
                    if (percentage === 100) {
                        progressRing.classList.add('text-teal-green-primary');
                    } else if (percentage >= 50) {
                        progressRing.classList.add('text-yellow-500');
                    } else {
                        progressRing.classList.add('text-soft-red-critical');
                    }
                }
            }
        };

        const renderHealthScore = (score) => {
            // This is largely replaced by the Live Vitals Overview card in the new design.
            // The score calculation logic remains for gamification/reports but no longer has a dedicated large circular card.
        };

        const renderMedLog = () => {
            // This section is removed from the new Home Page design.
        };

        const renderVitalsForm = () => {
            // Form inputs are hidden but values are kept in state.
        };

        const renderTasks = () => {
            const taskListEl = document.getElementById('task-list');
            if (!taskListEl) return;

            taskListEl.innerHTML = appState.tasks.map(task => {
                const isDone = task.isChecked;
                const statusText = isDone ? 'Done' : (task.time < new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }) ? 'Pending' : 'Upcoming');

                const checkedClass = isDone ? 'task-done' : 'bg-white border-gray-300 hover:bg-soft-mint-white';
                const iconBgClass = isDone ? 'bg-teal-green-primary' : (statusText === 'Pending' ? 'bg-soft-red-critical' : 'bg-warm-yellow');
                const iconColorClass = 'text-white';
                const textClass = isDone ? 'text-teal-green-primary line-through' : 'text-dark-navy';
                const statusIcon = isDone ? 'check-circle' : (statusText === 'Pending' ? 'alert-triangle' : 'clock');
                const statusIconColor = isDone ? 'text-teal-green-primary' : (statusText === 'Pending' ? 'text-soft-red-critical' : 'text-warm-yellow');

                return `
                    <button
                        onclick="toggleTask(${task.id})"
                        class="w-full p-4 rounded-xl text-left flex items-center justify-between text-xl font-semibold transition-all duration-500 shadow-lg border-2 ${checkedClass}"
                    >
                        <div class="flex items-center space-x-4">
                            <div class="p-3 rounded-full ${iconBgClass} ${iconColorClass} flex-shrink-0">
                                <i data-lucide="${task.icon}" class="w-6 h-6"></i>
                            </div>
                            <div class="flex flex-col text-left">
                                <span class="${textClass} text-lg">${task.name}</span>
                                <span class="text-sm text-gray-500">${task.time}</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <i data-lucide="${statusIcon}" class="w-6 h-6 ${statusIconColor} ${isDone ? 'animate-pulse' : ''}"></i>
                            <span class="text-xs font-bold ${statusIconColor.replace('text', 'text-').replace('-500', '-700')}">${statusText}</span>
                        </div>
                    </button>
                `;
            }).join('');
        };
        
        // Add Task Handler
        document.getElementById('add-task-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('new-task-title').value;
            const time = document.getElementById('new-task-time').value;
            const type = document.getElementById('new-task-type').value;

            if (title && time && type) {
                const newTask = {
                    id: appState.taskIdCounter++,
                    name: title,
                    icon: type,
                    isChecked: false,
                    target: null,
                    unit: 'n/a',
                    time: new Date(`2000/01/01 ${time}`).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                };
                appState.tasks.push(newTask);
                document.getElementById('new-task-title').value = '';
                document.getElementById('new-task-time').value = '';
                renderUI();
                saveState();
            }
        });
        
        // --- Remaining render functions (Progress, Profile, Chart) are largely unchanged in logic, but use the new colors/styles for consistency ---

        const renderProgress = () => {
            const game = appState.gamification;
            const streakDisplayEl = document.getElementById('streak-display');
            const levelDisplayEl = document.getElementById('level-display');
            const progressBarEl = document.getElementById('progress-bar');
            const badgesContainerEl = document.getElementById('badges-container');
            
            if (streakDisplayEl) streakDisplayEl.textContent = game.streak;
            if (levelDisplayEl) levelDisplayEl.textContent = game.level;
            if (progressBarEl) progressBarEl.style.width = `${game.progressToNextLevel}%`;

            if (badgesContainerEl) {
                badgesContainerEl.innerHTML = game.badges.map(badge => {
                    const color = badge.earned ? badge.color.replace('bg-', 'bg-') : 'bg-gray-300';
                    const hover = badge.earned ? 'hover:scale-110' : '';
                    const animation = badge.earned ? 'animate-float' : '';

                    return `
                        <div class="p-4 flex flex-col items-center rounded-xl ${color} shadow-lg transition duration-300 ${hover} ${animation} cursor-pointer badge-earned" title="${badge.name}">
                            <i data-lucide="${badge.icon}" class="w-8 h-8 ${badge.earned ? 'text-gray-800' : 'text-gray-600'}"></i>
                            <span class="text-xs font-semibold mt-1 text-center">${badge.name}</span>
                        </div>
                    `;
                }).join('');
            }
        };

        const renderProfileForm = () => {
            document.getElementById('profile-name').value = appState.profile.name;
            document.getElementById('profile-dob').value = appState.profile.dob;
            document.getElementById('profile-conditions').value = appState.profile.conditions;
            document.getElementById('profile-emergency-contact').value = appState.profile.emergencyContact;
        };
        
        const renderChart = () => {
            const chartContainerEl = document.getElementById('chart-container');
            const chartLabelsEl = document.getElementById('chart-labels');

            if (!chartContainerEl || !chartLabelsEl) return;

            chartContainerEl.innerHTML = '';
            chartLabelsEl.innerHTML = '';
            
            appState.healthData.slice(-7).forEach(data => {
                const riskHeight = data.risk * 2;
                const barColor = data.risk < 10 ? 'bg-teal-green-primary' : data.risk < 20 ? 'bg-warm-yellow' : 'bg-soft-red-critical';

                const barEl = document.createElement('div');
                barEl.className = `w-1/8 mx-1 rounded-t-lg shadow-lg flex flex-col justify-end items-center text-white font-bold text-xs ${barColor} chart-bar`;
                barEl.style.height = `${riskHeight}px`;

                const riskTextEl = document.createElement('span');
                riskTextEl.textContent = `${data.risk}%`;
                riskTextEl.className = 'p-1';
                barEl.appendChild(riskTextEl);
                chartContainerEl.appendChild(barEl);

                const labelEl = document.createElement('div');
                labelEl.className = 'w-1/8 text-center';
                labelEl.textContent = data.day;
                chartLabelsEl.appendChild(labelEl);
            });
        };

        // --- EVENT HANDLERS (Adjusted for new colors/elements) ---
        window.toggleTask = (id) => {
            const oldScore = calculateHealthScore();
            appState.tasks = appState.tasks.map(task =>
                task.id === id ? { ...task, isChecked: !task.isChecked } : task
            );
            const newScore = calculateHealthScore();
            
            // Trigger confetti on completion
            const task = appState.tasks.find(t => t.id === id);
            if(task && task.isChecked) {
                confetti({ particleCount: 50, spread: 60 });
            }

            // Update doses taken for medication tracker
            const dosesTaken = appState.tasks.filter(t => t.icon === 'Pill' && t.isChecked).length;
            const totalDoses = appState.tasks.filter(t => t.icon === 'Pill').length;
            if(appState.medicationHistory.length > 0) {
                 appState.medicationHistory[0].dosesTaken = dosesTaken;
                 appState.medicationHistory[0].totalDoses = totalDoses;
            }
            
            checkLevelUp(oldScore, newScore);
            const newBadges = checkForNewBadges(oldScore, newScore);
            
            if (newBadges.length > 0) {
                triggerCelebration('badge');
            }
            
            renderUI();
            saveState();
        };

        document.getElementById('vitals-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newVitals = {
                hr: parseInt(document.getElementById('input-hr').value) || appState.vitals.hr,
                bp: document.getElementById('input-bp').value || appState.vitals.bp,
                bg: parseInt(document.getElementById('input-bg').value) || appState.vitals.bg,
                spo2: parseInt(document.getElementById('input-spo2').value) || appState.vitals.spo2,
            };

            appState.vitals = newVitals;
            renderUI();
            saveState();

            document.getElementById('vitals-form').querySelector('button').textContent = 'Vitals Saved!';
            setTimeout(() => {
                document.getElementById('vitals-form').querySelector('button').textContent = 'Save Vitals';
            }, 1500);
        });

        document.getElementById('profile-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            
            appState.profile = {
                name: document.getElementById('profile-name').value,
                dob: document.getElementById('profile-dob').value,
                conditions: document.getElementById('profile-conditions').value,
                emergencyContact: document.getElementById('profile-emergency-contact').value
            };
            
            renderUI();
            saveState();
            
            // Show confirmation
            const button = document.getElementById('profile-form').querySelector('button');
            const originalText = button.textContent;
            button.textContent = 'Profile Saved!';
            button.classList.remove('bg-teal-green-primary');
            button.classList.add('bg-green-500');
            
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('bg-green-500');
                button.classList.add('bg-teal-green-primary');
            }, 1500);
        });

        // ABDM Export Functions (Unchanged)
        document.getElementById('export-abdm-btn')?.addEventListener('click', () => {
            const exportStatus = document.getElementById('export-status');
            exportStatus.className = 'mt-4 text-center font-semibold text-lg text-blue-600';
            exportStatus.innerHTML = `<i data-lucide="loader" class="w-6 h-6 inline-block mr-2 animate-spin"></i> Preparing health data export...`;
            window.createLucideIcons();
            
            // Simulate export process
            setTimeout(() => {
                // Create CSV content
                const headers = "Date,Heart Rate,Blood Pressure,Blood Glucose,SpO2,Compliance Score\n";
                const rows = appState.healthData.map(data => 
                    `${data.day},${appState.vitals.hr},${appState.vitals.bp},${appState.vitals.bg},${appState.vitals.spo2},${data.score}`
                ).join("\n");
                const csvContent = headers + rows;
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `health_data_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                exportStatus.className = 'mt-4 text-center font-semibold text-lg text-green-600';
                exportStatus.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6 inline-block mr-2"></i> Health data exported successfully!`;
                window.createLucideIcons();
                
                setTimeout(() => {
                    exportStatus.innerHTML = '';
                }, 3000);
            }, 1500);
        });

        document.getElementById('export-meds-btn')?.addEventListener('click', () => {
            const exportStatus = document.getElementById('export-status');
            exportStatus.className = 'mt-4 text-center font-semibold text-lg text-blue-600';
            exportStatus.innerHTML = `<i data-lucide="loader" class="w-6 h-6 inline-block mr-2 animate-spin"></i> Preparing medication data export...`;
            window.createLucideIcons();
            
            // Simulate export process
            setTimeout(() => {
                // Create CSV content for medications
                const headers = "Date,Medication,Status\n";
                const rows = appState.medicationHistory.flatMap(day => 
                    day.meds.map(med => `${day.date},${med},Taken`)
                ).join("\n");
                const csvContent = headers + rows;
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `medication_data_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                exportStatus.className = 'mt-4 text-center font-semibold text-lg text-green-600';
                exportStatus.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6 inline-block mr-2"></i> Medication data exported successfully!`;
                window.createLucideIcons();
                
                setTimeout(() => {
                    exportStatus.innerHTML = '';
                }, 3000);
            }, 1500);
        });

        window.changePage = (pageName, buttonEl) => {
            if (pageName === appState.currentPage) return;

            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(`page-${pageName}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if(buttonEl) {
                buttonEl.classList.add('active');
            }

            appState.currentPage = pageName;
            renderUI();
        };

        // --- ALERT LOGIC (Unchanged) ---
        const triggerSmartAlert = async (receiverType, message) => {
            const receiver = receiverType === 'family' ? 'Family Member' : 'Healthcare Provider';
            const alertStatusEl = document.getElementById('alert-status');
            
            alertStatusEl.className = 'mt-4 text-center font-semibold text-xl text-teal-600';
            alertStatusEl.innerHTML = `<i data-lucide="loader" class="w-6 h-6 inline-block mr-2 animate-spin"></i> Sending alert to ${receiver}...`;
            window.createLucideIcons();

            await new Promise(resolve => setTimeout(resolve, 1500));

            console.log(`[Smart Alert] Sent to ${receiver}: ${message}`);
            alertStatusEl.className = 'mt-4 text-center font-semibold text-xl text-green-600';
            alertStatusEl.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6 inline-block mr-2"></i> Alert sent successfully to ${receiver}!`;
            window.createLucideIcons();

            setTimeout(() => {
                alertStatusEl.innerHTML = '';
            }, 3000);
        };

        window.handleAlertHoldStart = (e) => {
            e.preventDefault();
            if (alertTimeout) clearTimeout(alertTimeout);
            
            alertBtn.classList.add('alert-active-pulse');
            
            alertTimeout = setTimeout(() => {
                alertBtn.classList.remove('alert-active-pulse');
                alertBtn.classList.add('bg-red-900', 'ring-8', 'ring-red-400');

                const emergencyMessage = `EMERGENCY ALERT: Patient activated the 3-second hold. Current Vitals: HR ${appState.vitals.hr}, BP ${appState.vitals.bp}.`;
                triggerSmartAlert('doctor', emergencyMessage);

                setTimeout(() => {
                    alertBtn.classList.remove('bg-red-900', 'ring-8', 'ring-red-400');
                }, 3000);

            }, ALERT_HOLD_DURATION);
        };

        window.handleAlertHoldEnd = (e) => {
            e.preventDefault();
            if (alertTimeout) {
                clearTimeout(alertTimeout);
                alertTimeout = null;
            }
            alertBtn.classList.remove('alert-active-pulse');
        };
        
        window.handleAlertHoldMove = (e) => {
            // Prevent accidental cancels on mobile
        }

        document.getElementById('alert-family-btn')?.addEventListener('click', () => {
            triggerSmartAlert('family', `Patient health compliance is at ${calculateHealthScore()}%. Just checking in.`);
        });
        
        document.getElementById('alert-doctor-btn')?.addEventListener('click', () => {
            const message = `Secure daily report: Compliance score ${calculateHealthScore()}%. Vitals: HR ${appState.vitals.hr}, BP ${appState.vitals.bp}.`;
            triggerSmartAlert('doctor', message);
        });

        // --- INITIALIZATION ---
        const renderUI = () => {
            renderHeader();
            const score = calculateHealthScore();
            renderHealthScore(score);
            renderTasks();
            renderMedLog();
            renderVitalsForm();
            renderProgress();
            renderProfileForm();
            renderChart();
            window.createLucideIcons();
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            renderUI();
            
            // Re-select the correct active button in the nav on load
            const activeNavButton = document.querySelector(`#bottom-nav button[onclick*="'${appState.currentPage}'"]`);
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if(activeNavButton) {
                activeNavButton.classList.add('active');
            }
            
            changePage(appState.currentPage, activeNavButton);
        });
    </script>
</body>
</html>
