<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPM Compliance Coach</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Confetti library for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script>
        // Configure Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'ping-slow': 'ping 2s cubic-bezier(0, 0, 0.2, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'scale-up': 'scaleUp 0.5s ease-out forwards',
                        'float': 'float 3s ease-in-out infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                        'pulse-glow': 'pulseGlow 2s infinite',
                    },
                    keyframes: {
                        scaleUp: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        },
                        pulseGlow: {
                            '0%, 100%': { boxShadow: '0 0 5px rgba(59, 130, 246, 0.5)' },
                            '50%': { boxShadow: '0 0 20px rgba(59, 130, 246, 0.8)' },
                        }
                    }
                }
            }
        }
        
        // Initialize Lucide icons
        window.createLucideIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons({ 
                    attrs: { 
                        'stroke-width': 2, 
                        'class': 'lucide' 
                    } 
                });
            }
        };
        document.addEventListener('DOMContentLoaded', window.createLucideIcons);
    </script>
    <style>
        /* General High-Contrast/Vibrant Styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdfa;
            padding-top: 150px;
            padding-bottom: 90px;
            line-height: 1.6;
        }
        .card {
            background-color: #ffffff;
            border: 1px solid #e0f2f1;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            border-radius: 1.5rem;
        }
        .card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(-2px);
        }
        /* Page Control */
        .page {
            display: none;
            padding: 1rem;
            min-height: calc(100vh - 240px);
        }
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0.5; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Fixed Header Styles */
        #fixed-header {
            z-index: 50;
            background-color: #0d9488;
            color: white;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Fixed Navbar Styles */
        #bottom-nav {
            background-color: #ffffff;
            border-top: 2px solid #e0f2f1;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.05);
            z-index: 60;
            height: 80px;
        }
        .nav-item {
            color: #4b5563;
            transition: color 0.3s, transform 0.2s;
            min-width: 20%;
        }
        .nav-item.active {
            color: #f97316;
            font-weight: bold;
            transform: scale(1.1);
        }

        /* Central Alert Button */
        #alert-center-btn-wrapper {
            position: relative;
            top: -20px;
            z-index: 70;
        }
        #alert-center-btn {
            background-color: #dc2626;
            transition: all 0.1s;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.7);
            border: 6px solid #fca5a5;
        }
        .alert-active-pulse {
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 25px rgba(255, 0, 0, 1);
            }
        }
        
        /* Custom button styles */
        .primary-btn {
            @apply text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 transform hover:scale-105 active:scale-95;
        }
        
        /* Chart bar animations */
        .chart-bar {
            transition: all 0.5s ease-out;
        }
        
        /* Input focus styles */
        input:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
        }
        
        /* Celebration animation */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        /* Badge animation */
        .badge-earned {
            animation: badgePop 0.8s ease-out;
        }
        
        @keyframes badgePop {
            0% { transform: scale(0); }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Achievement celebration */
        .achievement-popup {
            animation: achievementSlide 0.5s ease-out;
        }
        
        @keyframes achievementSlide {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>

    <!-- FIXED TOP HEADER -->
    <header id="fixed-header" class="fixed top-0 left-0 right-0">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <!-- Logo & User Info -->
            <div class="flex items-center space-x-4">
                <i data-lucide="compass" class="w-10 h-10 text-orange-300 animate-spin-slow"></i>
                <div>
                    <p class="text-lg font-bold">Hello, <span id="header-user-name">John Doe</span></p>
                    <p class="text-sm text-teal-200 flex items-center">
                        <i data-lucide="heart" class="w-4 h-4 mr-1"></i> HR: <span id="hr-display">72</span> bpm
                    </p>
                </div>
            </div>

            <!-- Vitals Quick View -->
            <div class="flex space-x-4 text-sm font-semibold">
                <div class="text-center">
                    <i data-lucide="droplet" class="w-5 h-5 mx-auto"></i>
                    <p>BG: <span id="bg-display">110</span></p>
                </div>
                <div class="text-center">
                    <i data-lucide="thermometer" class="w-5 h-5 mx-auto"></i>
                    <p>BP: <span id="bp-display">120/80</span></p>
                </div>
                <div class="text-center">
                    <i data-lucide="wind" class="w-5 h-5 mx-auto"></i>
                    <p>SpO2: <span id="spo2-display">97</span></p>
                </div>
            </div>
        </div>

        <!-- Medication & Connectivity Report -->
        <div class="max-w-7xl mx-auto mt-3 pt-3 border-t border-teal-600 flex justify-between text-sm">
            <div class="w-1/2 pr-2">
                <p class="font-bold text-teal-200">Next Dose:</p>
                <p id="next-med-display" class="text-yellow-200">Aspirin at 8:00 PM</p>
            </div>
            <div class="w-1/2 pl-2 border-l border-teal-600 flex items-center justify-end space-x-2">
                <p class="font-bold text-teal-200">Team:</p>
                <i data-lucide="user-check" class="w-5 h-5 text-green-300" title="Doctor Connected"></i>
                <i data-lucide="users-2" class="w-5 h-5 text-orange-300" title="Relatives Alerted"></i>
            </div>
        </div>
    </header>

    <!-- Celebration Container -->
    <div id="celebration-container" class="celebration"></div>

    <!-- Achievement Popup -->
    <div id="achievement-popup" class="fixed top-20 right-4 bg-white p-4 rounded-xl shadow-2xl z-50 hidden achievement-popup">
        <div class="flex items-center space-x-3">
            <i data-lucide="award" class="w-8 h-8 text-yellow-500"></i>
            <div>
                <p class="font-bold text-lg">Achievement Unlocked!</p>
                <p id="achievement-text" class="text-gray-600">New badge earned</p>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <main class="max-w-4xl mx-auto pt-4">

        <!-- 1. HOME PAGE -->
        <div id="page-home" class="page active">
            <h2 class="text-3xl font-bold text-teal-700 mb-5">
                <i data-lucide="home" class="w-8 h-8 mr-2 text-orange-500 inline-block"></i> Dashboard
            </h2>

            <!-- Compliance Score Card -->
            <div id="health-score-card" class="card p-8 flex flex-col items-center justify-center text-center bg-gradient-to-br from-teal-50 to-white min-h-[200px] mb-6">
                <div class="relative w-40 h-40 rounded-full flex flex-col items-center justify-center font-extrabold text-white text-4xl shadow-2xl border-8 border-teal-300 bg-teal-500 transition-all duration-500">
                    <i data-lucide="heart-pulse" class="absolute w-12 h-12 opacity-30 animate-ping-slow"></i>
                    <span id="score-display">--</span>
                </div>
                <h3 class="text-3xl mt-4 font-bold text-teal-800">Compliance Score</h3>
                <p id="score-message" class="text-lg text-gray-600">You're doing great!</p>
            </div>

            <!-- Past 2 Days Medication Report -->
            <div class="card p-6 mb-6">
                <h3 class="text-2xl font-bold text-teal-700 mb-3 flex items-center">
                    <i data-lucide="history" class="w-6 h-6 mr-2 text-blue-500"></i> Past 2-Day Medication Log
                </h3>
                <div id="med-log-display" class="space-y-2 text-lg">
                    <!-- Medication log will be populated here -->
                </div>
            </div>

            <!-- Vitals Input Form -->
            <div class="card p-6 bg-teal-50">
                <h3 class="text-2xl font-bold text-teal-700 mb-3 flex items-center">
                    <i data-lucide="hand" class="w-6 h-6 mr-2 text-orange-500"></i> Enter Today's Vitals
                </h3>
                <form id="vitals-form" class="space-y-4">
                    <input type="number" id="input-hr" placeholder="Heart Rate (bpm)" class="w-full p-3 border-2 border-teal-300 rounded-lg text-lg focus:ring-teal-500 focus:border-teal-500">
                    <input type="text" id="input-bp" placeholder="BP (e.g., 120/80)" class="w-full p-3 border-2 border-teal-300 rounded-lg text-lg focus:ring-teal-500 focus:border-teal-500">
                    <input type="number" id="input-bg" placeholder="Blood Glucose (mg/dL)" class="w-full p-3 border-2 border-teal-300 rounded-lg text-lg focus:ring-teal-500 focus:border-teal-500">
                    <input type="number" id="input-spo2" placeholder="SpO2 (%)" class="w-full p-3 border-2 border-teal-300 rounded-lg text-lg focus:ring-teal-500 focus:border-teal-500">
                    <button type="submit" class="w-full primary-btn bg-green-500 hover:bg-green-600">Save Vitals</button>
                </form>
            </div>
        </div>

        <!-- 2. TO-DO LIST PAGE -->
        <div id="page-todo" class="page">
            <h2 class="text-3xl font-bold text-teal-700 mb-5">
                <i data-lucide="list-checks" class="w-8 h-8 mr-2 text-orange-500 inline-block"></i> Daily Checklist
            </h2>
            <div id="task-list" class="space-y-4">
                <!-- Tasks will be injected here by JavaScript -->
            </div>
        </div>

        <!-- 3. PROGRESS GAME PAGE -->
        <div id="page-progress" class="page text-center">
            <h2 class="text-3xl font-bold text-teal-700 mb-5">
                <i data-lucide="trophy" class="w-8 h-8 mr-2 text-orange-500 inline-block"></i> Your Progress
            </h2>
            
            <!-- Streak Counter -->
            <div class="card p-6 mb-6 bg-orange-50">
                <div class="flex items-center justify-center space-x-4">
                    <i data-lucide="flame" class="w-10 h-10 text-orange-500"></i>
                    <div>
                        <p class="text-xl text-gray-600 font-semibold">Current Streak</p>
                        <p class="text-4xl font-extrabold text-orange-700"><span id="streak-display">3</span> days</p>
                    </div>
                </div>
            </div>
            
            <!-- Gamified Level & Progress Bar -->
            <div class="card p-6 mb-8 bg-yellow-50">
                <p class="text-xl text-gray-600 font-semibold">Your Current Health Level:</p>
                <div class="text-6xl font-extrabold text-teal-700 my-3 relative inline-block">
                    Level <span id="level-display">5</span>
                    <i data-lucide="zap" class="w-8 h-8 absolute top-0 right-[-30px] text-orange-500 animate-bounce-slow"></i>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden">
                    <div id="progress-bar" class="bg-orange-500 h-4 rounded-full transition-all duration-1000 ease-out" style="width: 65%;"></div>
                    <span class="absolute top-0 left-1/2 transform -translate-x-1/2 text-sm text-white font-bold">65% to next level!</span>
                </div>
            </div>
            
            <!-- Badges -->
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-teal-700 mb-4 flex items-center">
                    <i data-lucide="award" class="w-6 h-6 mr-2 text-yellow-500"></i> Badges Earned
                </h3>
                <div id="badges-container" class="grid grid-cols-3 sm:grid-cols-5 gap-4">
                    <!-- Badges will be injected here by JavaScript -->
                </div>
            </div>
            
            <!-- Level Up Animation Modal -->
            <div id="levelup-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden" onclick="this.classList.add('hidden')">
                <div class="bg-white p-8 rounded-3xl text-center shadow-2xl relative animate-scale-up" onclick="event.stopPropagation()">
                    <i data-lucide="star" class="w-16 h-16 text-yellow-500 mx-auto animate-spin-slow"></i>
                    <h3 class="text-4xl font-extrabold text-green-600 mt-4">LEVEL UP!</h3>
                    <p class="text-2xl text-gray-700 mt-2">You reached Level <span id="new-level-display">6</span>!</p>
                    <button class="mt-5 px-6 py-3 bg-teal-500 text-white font-bold rounded-xl hover:bg-teal-600 transition-all">Awesome!</button>
                </div>
            </div>
        </div>

        <!-- 4. SETTINGS & REPORT PAGE -->
        <div id="page-settings" class="page">
            <h2 class="text-3xl font-bold text-teal-700 mb-5">
                <i data-lucide="settings" class="w-8 h-8 mr-2 text-orange-500 inline-block"></i> Settings & Reports
            </h2>
            <div class="space-y-6">
                <!-- Profile Settings -->
                <div class="card p-6">
                    <h3 class="text-2xl font-bold text-teal-700 mb-3 flex items-center">
                        <i data-lucide="user" class="w-6 h-6 mr-2 text-blue-500"></i> Profile Settings
                    </h3>
                    <form id="profile-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Full Name</label>
                                <input type="text" id="profile-name" class="w-full p-3 border-2 border-teal-300 rounded-lg text-lg focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">Date of Birth</label>
                                <input type="date" id="profile-dob" class="w-full p-3 border-2 border-teal-300 rounded-lg text-lg focus:ring-teal-500 focus:border-teal-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Health Conditions</label>
                            <textarea id="profile-conditions" rows="3" class="w-full p-3 border-2 border-teal-300 rounded-lg text-lg focus:ring-teal-500 focus:border-teal-500" placeholder="List any health conditions..."></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Emergency Contact</label>
                            <input type="text" id="profile-emergency-contact" class="w-full p-3 border-2 border-teal-300 rounded-lg text-lg focus:ring-teal-500 focus:border-teal-500" placeholder="Name and phone number">
                        </div>
                        <button type="submit" class="w-full primary-btn bg-teal-500 hover:bg-teal-600">Save Profile</button>
                    </form>
                </div>

                <!-- Connection Settings -->
                <div class="card p-6 bg-teal-50">
                    <h3 class="text-2xl font-bold text-teal-700 mb-3 flex items-center">
                        <i data-lucide="users" class="w-6 h-6 mr-2 text-green-500"></i> Connection Settings
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-teal-200">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="user-check" class="w-6 h-6 text-green-500"></i>
                                <div>
                                    <p class="font-semibold">Dr. Sarah Johnson</p>
                                    <p class="text-sm text-gray-500">Primary Care Physician</p>
                                </div>
                            </div>
                            <button class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors">Manage</button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-teal-200">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="users-2" class="w-6 h-6 text-orange-500"></i>
                                <div>
                                    <p class="font-semibold">Family Members</p>
                                    <p class="text-sm text-gray-500">3 connected family members</p>
                                </div>
                            </div>
                            <button class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors">Manage</button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-teal-200">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="activity" class="w-6 h-6 text-purple-500"></i>
                                <div>
                                    <p class="font-semibold">Health Devices</p>
                                    <p class="text-sm text-gray-500">2 connected devices</p>
                                </div>
                            </div>
                            <button class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors">Manage</button>
                        </div>
                    </div>
                </div>
                
                <!-- ABDM Data Export -->
                <div class="card p-6 bg-blue-50">
                    <h3 class="text-2xl font-bold text-teal-700 mb-3 flex items-center">
                        <i data-lucide="database" class="w-6 h-6 mr-2 text-blue-500"></i> ABDM Data Export
                    </h3>
                    <p class="text-lg text-gray-600 mb-4">Export your health data in ABDM-compatible format for sharing with healthcare providers.</p>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-blue-200">
                            <div>
                                <p class="font-semibold">Health Data Summary</p>
                                <p class="text-sm text-gray-500">Vitals, medications, and compliance data</p>
                            </div>
                            <button id="export-abdm-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                <span>Export CSV</span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-blue-200">
                            <div>
                                <p class="font-semibold">Medication History</p>
                                <p class="text-sm text-gray-500">Complete medication adherence records</p>
                            </div>
                            <button id="export-meds-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                <span>Export CSV</span>
                            </button>
                        </div>
                    </div>
                    <div id="export-status" class="mt-4 text-center font-semibold text-lg"></div>
                </div>

                <!-- Trend Prediction Visualization -->
                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-3 text-teal-700 flex items-center">
                        <i data-lucide="activity" class="w-6 h-6 mr-2 text-blue-500"></i> Risk Forecasting
                    </h3>
                    <p class="text-lg text-gray-600 mb-4">Risk trend based on recent data:</p>
                    
                    <!-- Simple Bar Chart Simulation -->
                    <div id="chart-container" class="flex justify-around items-end h-48 border-b-2 border-gray-200 pt-2">
                        <!-- Chart bars will be injected here -->
                    </div>
                    <div id="chart-labels" class="flex justify-around text-sm font-medium text-gray-500 mt-2">
                        <!-- Labels will be injected here -->
                    </div>
                    <p id="predictive-insight" class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-400 text-blue-800 text-lg font-medium">
                        <span class="font-bold">Insight:</span> Keep your adherence above 80% to maintain a low-risk status.
                    </p>
                </div>

                <!-- Report Send Controls -->
                <div class="card p-6 bg-teal-50">
                    <h3 class="text-2xl font-bold text-teal-700 mb-3 flex items-center">
                        <i data-lucide="send" class="w-6 h-6 mr-2 text-green-500"></i> Share Progress
                    </h3>
                    <p class="text-xl text-gray-600 mb-4">Securely share your health summary.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="alert-family-btn" class="w-full primary-btn bg-orange-500 hover:bg-orange-600 shadow-md flex items-center justify-center space-x-2">
                            <i data-lucide="users" class="w-6 h-6"></i>
                            <span>Send to Family</span>
                        </button>
                        <button id="alert-doctor-btn" class="w-full primary-btn bg-green-500 hover:bg-green-600 shadow-md flex items-center justify-center space-x-2">
                            <i data-lucide="user-check" class="w-6 h-6"></i>
                            <span>Send to Doctor</span>
                        </button>
                    </div>
                    <p id="alert-status" class="mt-4 text-center font-semibold text-xl"></p>
                </div>
            </div>
        </div>
    </main>

    <!-- FIXED BOTTOM NAV BAR -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 h-20 flex justify-around items-center">
        <button onclick="changePage('home', this)" class="nav-item flex flex-col items-center justify-center active">
            <i data-lucide="home" class="w-7 h-7"></i>
            <span class="text-xs">Home</span>
        </button>
        <button onclick="changePage('todo', this)" class="nav-item flex flex-col items-center justify-center">
            <i data-lucide="list-checks" class="w-7 h-7"></i>
            <span class="text-xs">To Do</span>
        </button>

        <!-- CENTER ALERT BUTTON -->
        <div id="alert-center-btn-wrapper" class="flex-shrink-0">
            <button id="alert-center-btn"
                    class="w-20 h-20 rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-2xl transform transition duration-150"
                    ontouchstart="handleAlertHoldStart(event)"
                    ontouchend="handleAlertHoldEnd(event)"
                    onmousedown="handleAlertHoldStart(event)"
                    onmouseup="handleAlertHoldEnd(event)"
                    ontouchmove="handleAlertHoldMove(event)">
                <i data-lucide="siren" class="w-8 h-8"></i>
            </button>
        </div>

        <button onclick="changePage('progress', this)" class="nav-item flex flex-col items-center justify-center">
            <i data-lucide="trending-up" class="w-7 h-7"></i>
            <span class="text-xs">Progress</span>
        </button>
        <button onclick="changePage('settings', this)" class="nav-item flex flex-col items-center justify-center">
            <i data-lucide="settings" class="w-7 h-7"></i>
            <span class="text-xs">Settings</span>
        </button>
    </nav>

    <script>
        // --- DATA & CONFIGURATION ---
        const TODAY_DATE_KEY = new Date().toDateString();

        const INITIAL_STATE = {
            profile: {
                name: "John Doe",
                dob: "1975-05-15",
                conditions: "Hypertension, Type 2 Diabetes",
                emergencyContact: "Jane Doe - (555) 123-4567"
            },
            tasks: [
                { id: 1, name: 'Take Blood Pressure', icon: 'Heart', isChecked: false, target: 120, unit: 'mmHg', time: '8:00 AM' },
                { id: 2, name: 'Check Blood Glucose', icon: 'Clock', isChecked: false, target: 100, unit: 'mg/dL', time: '8:30 AM' },
                { id: 3, name: 'Take Morning Medication', icon: 'Pill', isChecked: false, target: 1, unit: 'pill', time: '9:00 AM' },
                { id: 4, name: '30 min Walk/Exercise', icon: 'Footprints', isChecked: false, target: 30, unit: 'min', time: '5:00 PM' },
                { id: 5, name: 'Take Evening Medication', icon: 'Pill', isChecked: false, target: 1, unit: 'pill', time: '8:00 PM' },
            ],
            vitals: {
                hr: 72,
                bp: '120/80',
                bg: 110,
                spo2: 97
            },
            medicationHistory: [
                { date: 'Mon', meds: ['Aspirin (AM)', 'Metformin (AM)'], nextDose: 'Aspirin (PM)' },
                { date: 'Sun', meds: ['Aspirin (AM)', 'Metformin (AM)', 'Aspirin (PM)'], nextDose: 'Aspirin (AM)' },
            ],
            gamification: {
                streak: 3,
                level: 5,
                progressToNextLevel: 65,
                badges: [
                    { id: 1, name: 'First Check-in', icon: 'CheckCircle', earned: true, color: 'bg-yellow-400' },
                    { id: 2, name: 'Consistent Care', icon: 'CalendarCheck', earned: false, color: 'bg-gray-300' },
                    { id: 3, name: 'Low Risk Status', icon: 'Shield', earned: false, color: 'bg-gray-300' },
                    { id: 4, name: 'Active Achiever', icon: 'Footprints', earned: true, color: 'bg-green-400' },
                    { id: 5, name: 'Perfect Week', icon: 'Star', earned: false, color: 'bg-gray-300' },
                    { id: 6, name: 'Vitals Master', icon: 'Activity', earned: false, color: 'bg-gray-300' },
                    { id: 7, name: 'Medication Pro', icon: 'Pill', earned: false, color: 'bg-gray-300' },
                    { id: 8, name: 'Health Champion', icon: 'Award', earned: false, color: 'bg-gray-300' },
                    { id: 9, name: 'Early Bird', icon: 'Sunrise', earned: false, color: 'bg-gray-300' },
                    { id: 10, name: 'Night Owl', icon: 'Moon', earned: false, color: 'bg-gray-300' },
                ],
            },
            healthData: [
                { day: 'Mon', score: 75, risk: 25 },
                { day: 'Tue', score: 80, risk: 20 },
                { day: 'Wed', score: 85, risk: 15 },
                { day: 'Thu', score: 90, risk: 10 },
                { day: 'Fri', score: 82, risk: 18 },
                { day: 'Sat', score: 95, risk: 5 },
                { day: 'Sun', score: 98, risk: 2 },
            ],
            currentPage: 'home',
            lastUpdatedDate: null,
        };

        let appState = {};
        let alertTimeout = null;
        const ALERT_HOLD_DURATION = 3000;

        // --- LOCAL STORAGE FUNCTIONS ---
        const loadState = () => {
            const savedState = localStorage.getItem('rpmCoachState');
            if (savedState) {
                appState = JSON.parse(savedState);
                
                // Reset tasks if it's a new day
                if (appState.lastUpdatedDate !== TODAY_DATE_KEY) {
                    appState.tasks = INITIAL_STATE.tasks.map(t => ({ ...t, isChecked: false }));
                    appState.lastUpdatedDate = TODAY_DATE_KEY;
                }
            } else {
                appState = { 
                    ...INITIAL_STATE, 
                    tasks: INITIAL_STATE.tasks.map(t => ({ ...t })),
                    lastUpdatedDate: TODAY_DATE_KEY
                };
            }
        };

        const saveState = () => {
            localStorage.setItem('rpmCoachState', JSON.stringify(appState));
        };

        // --- CELEBRATION FUNCTIONS ---
        const triggerCelebration = (type = 'achievement') => {
            // Confetti celebration
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            // Additional effects based on type
            if (type === 'levelup') {
                setTimeout(() => {
                    confetti({
                        particleCount: 100,
                        angle: 60,
                        spread: 80,
                        origin: { x: 0 }
                    });
                    confetti({
                        particleCount: 100,
                        angle: 120,
                        spread: 80,
                        origin: { x: 1 }
                    });
                }, 250);
            }
            
            // Show achievement popup
            const popup = document.getElementById('achievement-popup');
            const achievementText = document.getElementById('achievement-text');
            
            if (type === 'levelup') {
                achievementText.textContent = `You've reached Level ${appState.gamification.level}!`;
            } else {
                achievementText.textContent = "You've earned a new badge!";
            }
            
            popup.classList.remove('hidden');
            
            setTimeout(() => {
                popup.classList.add('hidden');
            }, 3000);
        };

        // --- BADGE CHECKING FUNCTION ---
        const checkForNewBadges = (oldScore, newScore) => {
            const newlyEarnedBadges = [];
            
            // Check for Perfect Week badge (7-day streak)
            if (appState.gamification.streak >= 7) {
                const badge = appState.gamification.badges.find(b => b.id === 5);
                if (badge && !badge.earned) {
                    badge.earned = true;
                    badge.color = 'bg-purple-400';
                    newlyEarnedBadges.push(badge);
                }
            }
            
            // Check for Vitals Master badge (consistent vitals logging)
            const vitalsLogged = appState.healthData.filter(d => d.score > 80).length;
            if (vitalsLogged >= 5) {
                const badge = appState.gamification.badges.find(b => b.id === 6);
                if (badge && !badge.earned) {
                    badge.earned = true;
                    badge.color = 'bg-blue-400';
                    newlyEarnedBadges.push(badge);
                }
            }
            
            // Check for Medication Pro badge (perfect medication adherence)
            if (newScore === 100) {
                const badge = appState.gamification.badges.find(b => b.id === 7);
                if (badge && !badge.earned) {
                    badge.earned = true;
                    badge.color = 'bg-green-400';
                    newlyEarnedBadges.push(badge);
                }
            }
            
            // Check for Health Champion badge (level 10)
            if (appState.gamification.level >= 10) {
                const badge = appState.gamification.badges.find(b => b.id === 8);
                if (badge && !badge.earned) {
                    badge.earned = true;
                    badge.color = 'bg-red-400';
                    newlyEarnedBadges.push(badge);
                }
            }
            
            // Return any newly earned badges
            return newlyEarnedBadges;
        };

        // --- UTILITY FUNCTIONS ---
        const calculateHealthScore = () => {
            const completed = appState.tasks.filter(t => t.isChecked).length;
            const total = appState.tasks.length;
            return total > 0 ? Math.round((completed / total) * 100) : 0;
        };

        const checkLevelUp = (oldScore, newScore) => {
            const oldLevel = appState.gamification.level;
            
            if (newScore > 90 && oldScore <= 90) {
                appState.gamification.level += 1;
                appState.gamification.progressToNextLevel = 10;
                showLevelUpAnimation(appState.gamification.level);
                
                // Earn a badge if available
                const lowRiskBadge = appState.gamification.badges.find(b => b.id === 3);
                if (lowRiskBadge && !lowRiskBadge.earned) {
                    lowRiskBadge.earned = true;
                    lowRiskBadge.color = 'bg-yellow-400';
                }
            } else if (newScore > oldScore) {
                appState.gamification.progressToNextLevel = Math.min(100, appState.gamification.progressToNextLevel + (newScore - oldScore) / 2);
            }
            
            // Check if level increased to trigger celebration
            if (appState.gamification.level > oldLevel) {
                triggerCelebration('levelup');
            }
        };
        
        const showLevelUpAnimation = (newLevel) => {
            const modal = document.getElementById('levelup-modal');
            document.getElementById('new-level-display').textContent = newLevel;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 5000);
        };

        // --- UI RENDER FUNCTIONS ---
        const renderHeader = () => {
            document.getElementById('header-user-name').textContent = appState.profile.name;
            document.getElementById('hr-display').textContent = appState.vitals.hr;
            document.getElementById('bp-display').textContent = appState.vitals.bp;
            document.getElementById('bg-display').textContent = appState.vitals.bg;
            document.getElementById('spo2-display').textContent = appState.vitals.spo2;

            const nextDose = appState.medicationHistory[0]?.nextDose || 'None Scheduled';
            document.getElementById('next-med-display').textContent = nextDose;
        };

        const renderHealthScore = (score) => {
            const scoreDisplayEl = document.getElementById('score-display');
            const scoreCardEl = document.querySelector('#health-score-card > div');
            const scoreMessageEl = document.getElementById('score-message');
            
            if (scoreDisplayEl) scoreDisplayEl.textContent = `${score}%`;

            if (scoreCardEl) {
                scoreCardEl.className = 'relative w-40 h-40 rounded-full flex flex-col items-center justify-center font-extrabold text-white text-4xl shadow-2xl border-8 transition-all duration-500';
                
                if (score >= 90) {
                    scoreCardEl.classList.add('border-green-300', 'bg-green-500');
                    if (scoreMessageEl) scoreMessageEl.textContent = 'Excellent! Keep it up!';
                } else if (score >= 60) {
                    scoreCardEl.classList.add('border-orange-300', 'bg-orange-500');
                    if (scoreMessageEl) scoreMessageEl.textContent = 'Good job! Almost there!';
                } else {
                    scoreCardEl.classList.add('border-red-300', 'bg-red-500');
                    if (scoreMessageEl) scoreMessageEl.textContent = 'Let\'s improve today!';
                }
            }
        };

        const renderMedLog = () => {
            const logEl = document.getElementById('med-log-display');
            if (!logEl) return;

            logEl.innerHTML = appState.medicationHistory.map(log => `
                <p class="text-gray-700"><span class="font-bold text-teal-600">${log.date}:</span> Took ${log.meds.join(', ')}.</p>
            `).join('');
        };

        const renderVitalsForm = () => {
            document.getElementById('input-hr').value = appState.vitals.hr;
            document.getElementById('input-bp').value = appState.vitals.bp;
            document.getElementById('input-bg').value = appState.vitals.bg;
            document.getElementById('input-spo2').value = appState.vitals.spo2;
        };

        const renderTasks = () => {
            const taskListEl = document.getElementById('task-list');
            if (!taskListEl) return;

            taskListEl.innerHTML = appState.tasks.map(task => {
                const checkedClass = task.isChecked ? 'bg-green-100 border-green-500' : 'bg-white border-gray-300 hover:bg-teal-50';
                const iconClass = task.isChecked ? 'text-white bg-green-500' : 'text-gray-500 bg-gray-100';
                const textClass = task.isChecked ? 'text-green-800 line-through' : 'text-gray-800';

                return `
                    <button
                        onclick="toggleTask(${task.id})"
                        class="w-full p-4 rounded-xl text-left flex items-center justify-between text-xl font-semibold transition-all duration-300 shadow-lg border-2 ${checkedClass}"
                    >
                        <div class="flex items-center space-x-4">
                            <div class="p-3 rounded-full ${iconClass} flex-shrink-0">
                                <i data-lucide="${task.icon}" class="w-6 h-6"></i>
                            </div>
                            <div class="flex flex-col text-left">
                                <span class="${textClass} text-2xl">${task.name}</span>
                                <span class="text-sm text-gray-500">${task.time} - Target: ${task.target} ${task.unit}</span>
                            </div>
                        </div>
                        ${task.isChecked ?
                            `<i data-lucide="check-circle" class="w-8 h-8 text-green-600 animate-pulse"></i>` :
                            `<i data-lucide="circle" class="w-8 h-8 text-gray-400"></i>`
                        }
                    </button>
                `;
            }).join('');
        };

        const renderProgress = () => {
            const game = appState.gamification;
            const streakDisplayEl = document.getElementById('streak-display');
            const levelDisplayEl = document.getElementById('level-display');
            const progressBarEl = document.getElementById('progress-bar');
            const badgesContainerEl = document.getElementById('badges-container');
            
            if (streakDisplayEl) streakDisplayEl.textContent = game.streak;
            if (levelDisplayEl) levelDisplayEl.textContent = game.level;
            if (progressBarEl) progressBarEl.style.width = `${game.progressToNextLevel}%`;

            if (badgesContainerEl) {
                badgesContainerEl.innerHTML = game.badges.map(badge => {
                    const color = badge.earned ? badge.color : 'bg-gray-300';
                    const hover = badge.earned ? 'hover:scale-110' : '';
                    const animation = badge.earned ? 'animate-float' : '';

                    return `
                        <div class="p-4 flex flex-col items-center rounded-xl ${color} shadow-lg transition duration-300 ${hover} ${animation} cursor-pointer badge-earned" title="${badge.name}">
                            <i data-lucide="${badge.icon}" class="w-8 h-8 ${badge.earned ? 'text-gray-800' : 'text-gray-600'}"></i>
                            <span class="text-xs font-semibold mt-1 text-center">${badge.name}</span>
                        </div>
                    `;
                }).join('');
            }
        };

        const renderProfileForm = () => {
            document.getElementById('profile-name').value = appState.profile.name;
            document.getElementById('profile-dob').value = appState.profile.dob;
            document.getElementById('profile-conditions').value = appState.profile.conditions;
            document.getElementById('profile-emergency-contact').value = appState.profile.emergencyContact;
        };

        const renderChart = () => {
            const chartContainerEl = document.getElementById('chart-container');
            const chartLabelsEl = document.getElementById('chart-labels');

            if (!chartContainerEl || !chartLabelsEl) return;

            chartContainerEl.innerHTML = '';
            chartLabelsEl.innerHTML = '';
            
            appState.healthData.slice(-7).forEach(data => {
                const riskHeight = data.risk * 2;
                const barColor = data.risk < 10 ? 'bg-green-500' : data.risk < 20 ? 'bg-orange-500' : 'bg-red-500';

                const barEl = document.createElement('div');
                barEl.className = `w-1/8 mx-1 rounded-t-lg shadow-lg flex flex-col justify-end items-center text-white font-bold text-xs ${barColor} chart-bar`;
                barEl.style.height = `${riskHeight}px`;

                const riskTextEl = document.createElement('span');
                riskTextEl.textContent = `${data.risk}%`;
                riskTextEl.className = 'p-1';
                barEl.appendChild(riskTextEl);
                chartContainerEl.appendChild(barEl);

                const labelEl = document.createElement('div');
                labelEl.className = 'w-1/8 text-center';
                labelEl.textContent = data.day;
                chartLabelsEl.appendChild(labelEl);
            });
        };

        // --- EVENT HANDLERS ---
        window.toggleTask = (id) => {
            const oldScore = calculateHealthScore();
            appState.tasks = appState.tasks.map(task =>
                task.id === id ? { ...task, isChecked: !task.isChecked } : task
            );
            const newScore = calculateHealthScore();
            
            // Check for level up and new badges
            checkLevelUp(oldScore, newScore);
            const newBadges = checkForNewBadges(oldScore, newScore);
            
            // Trigger celebration if new badges were earned
            if (newBadges.length > 0) {
                triggerCelebration('badge');
            }
            
            renderUI();
            saveState();
        };

        document.getElementById('vitals-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newVitals = {
                hr: parseInt(document.getElementById('input-hr').value) || appState.vitals.hr,
                bp: document.getElementById('input-bp').value || appState.vitals.bp,
                bg: parseInt(document.getElementById('input-bg').value) || appState.vitals.bg,
                spo2: parseInt(document.getElementById('input-spo2').value) || appState.vitals.spo2,
            };

            appState.vitals = newVitals;
            renderUI();
            saveState();

            document.getElementById('vitals-form').querySelector('button').textContent = 'Vitals Saved!';
            setTimeout(() => {
                document.getElementById('vitals-form').querySelector('button').textContent = 'Save Vitals';
            }, 1500);
        });

        document.getElementById('profile-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            
            appState.profile = {
                name: document.getElementById('profile-name').value,
                dob: document.getElementById('profile-dob').value,
                conditions: document.getElementById('profile-conditions').value,
                emergencyContact: document.getElementById('profile-emergency-contact').value
            };
            
            renderUI();
            saveState();
            
            // Show confirmation
            const button = document.getElementById('profile-form').querySelector('button');
            const originalText = button.textContent;
            button.textContent = 'Profile Saved!';
            button.classList.add('bg-green-500');
            
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('bg-green-500');
            }, 1500);
        });

        // ABDM Export Functions
        document.getElementById('export-abdm-btn')?.addEventListener('click', () => {
            const exportStatus = document.getElementById('export-status');
            exportStatus.className = 'mt-4 text-center font-semibold text-lg text-blue-600';
            exportStatus.innerHTML = `<i data-lucide="loader" class="w-6 h-6 inline-block mr-2 animate-spin"></i> Preparing health data export...`;
            window.createLucideIcons();
            
            // Simulate export process
            setTimeout(() => {
                // Create CSV content
                const headers = "Date,Heart Rate,Blood Pressure,Blood Glucose,SpO2,Compliance Score\n";
                const rows = appState.healthData.map(data => 
                    `${data.day},${appState.vitals.hr},${appState.vitals.bp},${appState.vitals.bg},${appState.vitals.spo2},${data.score}`
                ).join("\n");
                const csvContent = headers + rows;
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `health_data_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                exportStatus.className = 'mt-4 text-center font-semibold text-lg text-green-600';
                exportStatus.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6 inline-block mr-2"></i> Health data exported successfully!`;
                window.createLucideIcons();
                
                setTimeout(() => {
                    exportStatus.innerHTML = '';
                }, 3000);
            }, 1500);
        });

        document.getElementById('export-meds-btn')?.addEventListener('click', () => {
            const exportStatus = document.getElementById('export-status');
            exportStatus.className = 'mt-4 text-center font-semibold text-lg text-blue-600';
            exportStatus.innerHTML = `<i data-lucide="loader" class="w-6 h-6 inline-block mr-2 animate-spin"></i> Preparing medication data export...`;
            window.createLucideIcons();
            
            // Simulate export process
            setTimeout(() => {
                // Create CSV content for medications
                const headers = "Date,Medication,Status\n";
                const rows = appState.medicationHistory.flatMap(day => 
                    day.meds.map(med => `${day.date},${med},Taken`)
                ).join("\n");
                const csvContent = headers + rows;
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `medication_data_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                exportStatus.className = 'mt-4 text-center font-semibold text-lg text-green-600';
                exportStatus.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6 inline-block mr-2"></i> Medication data exported successfully!`;
                window.createLucideIcons();
                
                setTimeout(() => {
                    exportStatus.innerHTML = '';
                }, 3000);
            }, 1500);
        });

        window.changePage = (pageName, buttonEl) => {
            if (pageName === appState.currentPage) return;

            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(`page-${pageName}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if(buttonEl) {
                buttonEl.classList.add('active');
            }

            appState.currentPage = pageName;
            renderUI();
        };

        // --- ALERT LOGIC ---
        const triggerSmartAlert = async (receiverType, message) => {
            const receiver = receiverType === 'family' ? 'Family Member' : 'Healthcare Provider';
            const alertStatusEl = document.getElementById('alert-status');
            
            alertStatusEl.className = 'mt-4 text-center font-semibold text-xl text-teal-600';
            alertStatusEl.innerHTML = `<i data-lucide="loader" class="w-6 h-6 inline-block mr-2 animate-spin"></i> Sending alert to ${receiver}...`;
            window.createLucideIcons();

            await new Promise(resolve => setTimeout(resolve, 1500));

            console.log(`[Smart Alert] Sent to ${receiver}: ${message}`);
            alertStatusEl.className = 'mt-4 text-center font-semibold text-xl text-green-600';
            alertStatusEl.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6 inline-block mr-2"></i> Alert sent successfully to ${receiver}!`;
            window.createLucideIcons();

            setTimeout(() => {
                alertStatusEl.innerHTML = '';
            }, 3000);
        };

        window.handleAlertHoldStart = (e) => {
            e.preventDefault();
            if (alertTimeout) clearTimeout(alertTimeout);
            
            alertBtn.classList.add('alert-active-pulse');
            
            alertTimeout = setTimeout(() => {
                alertBtn.classList.remove('alert-active-pulse');
                alertBtn.classList.add('bg-red-900', 'ring-8', 'ring-red-400');

                const emergencyMessage = `EMERGENCY ALERT: Patient activated the 3-second hold. Current Vitals: HR ${appState.vitals.hr}, BP ${appState.vitals.bp}.`;
                triggerSmartAlert('doctor', emergencyMessage);

                setTimeout(() => {
                    alertBtn.classList.remove('bg-red-900', 'ring-8', 'ring-red-400');
                }, 3000);

            }, ALERT_HOLD_DURATION);
        };

        window.handleAlertHoldEnd = (e) => {
            e.preventDefault();
            if (alertTimeout) {
                clearTimeout(alertTimeout);
                alertTimeout = null;
            }
            alertBtn.classList.remove('alert-active-pulse');
        };
        
        window.handleAlertHoldMove = (e) => {
            // Prevent accidental cancels on mobile
        }

        document.getElementById('alert-family-btn')?.addEventListener('click', () => {
            triggerSmartAlert('family', `Patient health compliance is at ${calculateHealthScore()}%. Just checking in.`);
        });
        
        document.getElementById('alert-doctor-btn')?.addEventListener('click', () => {
            const message = `Secure daily report: Compliance score ${calculateHealthScore()}%. Vitals: HR ${appState.vitals.hr}, BP ${appState.vitals.bp}.`;
            triggerSmartAlert('doctor', message);
        });

        // --- INITIALIZATION ---
        const renderUI = () => {
            renderHeader();
            const score = calculateHealthScore();
            renderHealthScore(score);
            renderTasks();
            renderMedLog();
            renderVitalsForm();
            renderProgress();
            renderProfileForm();
            renderChart();
            window.createLucideIcons();
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            renderUI();
            changePage(appState.currentPage, document.querySelector(`.nav-item.active`));
        });
    </script>
</body>
</html>